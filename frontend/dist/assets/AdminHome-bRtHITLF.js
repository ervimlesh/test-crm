import{g as V,r as g,j as n,u as W,p as B,v as J}from"./index-DDoEHnfR.js";import{L as z}from"./Layout-Co7qzEc2.js";import{S as F}from"./SideBar-DCoEgSRU.js";import{createPeerConnection as H}from"./Webrtc-BBRU1ZdI.js";import{V as M}from"./VideoTile-BdOxT984.js";const U=({onAgentSelected:r,onScreenShareStarted:s,selectedAgents:h=[],remoteStreams:k={}})=>{const m=V(),[c,y]=g.useState([]),[_,L]=g.useState(!1),[w,R]=g.useState(!1),[A,I]=g.useState(""),[q,T]=g.useState(null);g.useEffect(()=>{var t;try{const d=localStorage.getItem("auth"),f=d?JSON.parse(d):null;T(((t=f==null?void 0:f.user)==null?void 0:t._id)||null)}catch(d){console.error("Error parsing auth:",d)}},[]),g.useEffect(()=>{if(!m)return;m.emit("get-agents-list");const t=({agents:N})=>{y(N||[])},d=({agents:N})=>{y(N||[])};m.on("agents-list",t),m.on("agents-list-updated",d);const f=setInterval(()=>{m.emit("get-agents-list")},5e3);return()=>{m.off("agents-list",t),m.off("agents-list-updated",d),clearInterval(f)}},[m]);const O=t=>{if(R(!0),h.includes(t._id)){R(!1);return}window.pendingScreenShareRequests||(window.pendingScreenShareRequests=new Set);const d=t._id;if(window.pendingScreenShareRequests.has(d)){console.warn(`[ScreenShareDropdown] Request already pending for agent ${t._id}`),R(!1);return}window.pendingScreenShareRequests.add(d),setTimeout(()=>window.pendingScreenShareRequests.delete(d),2e3),m==null||m.emit("request-view",{agentId:t._id,reason:"admin-screen-share"}),r==null||r(t._id,t.userName),s==null||s(t._id),I(""),L(!1),R(!1)},j=c.filter(t=>{var d,f;return!h.includes(t._id)&&(((d=t.userName)==null?void 0:d.toLowerCase().includes(A.toLowerCase()))||((f=t.email)==null?void 0:f.toLowerCase().includes(A.toLowerCase())))}),S=c.find(t=>t._id===q),u=S?[S,...j.filter(t=>t._id!==q)]:j;return n.jsxs("div",{className:"screen-share-dropdown-container",children:[n.jsxs("div",{className:"dropdown-wrapper",children:[n.jsxs("button",{className:"dropdown-toggle",onClick:()=>L(!_),disabled:w,children:[n.jsx("span",{className:"dropdown-icon",children:"ðŸ‘¥"}),n.jsx("span",{className:"dropdown-text",children:h.length>0?`${h.length} agent(s) selected`:"Select Agent"}),n.jsx("span",{className:`chevron ${_?"open":""}`,children:"â–¼"})]}),_&&n.jsxs("div",{className:"dropdown-menu",children:[n.jsx("div",{className:"dropdown-search",children:n.jsx("input",{type:"text",placeholder:"Search agent name or email...",value:A,onChange:t=>I(t.target.value),className:"search-input"})}),n.jsx("div",{className:"dropdown-content",children:w?n.jsx("div",{className:"loading-state",children:"Loading agents..."}):u.length>0?n.jsx("ul",{className:"agents-list",children:u.map(t=>n.jsxs("li",{className:`agent-item ${t._id===q?"current-user":""}`,onClick:()=>O(t),children:[n.jsxs("div",{className:"agent-info",children:[n.jsxs("div",{className:"agent-name",children:[t.userName,t._id===q&&n.jsx("span",{className:"current-badge",children:" (You)"})]}),n.jsx("div",{className:"agent-email",children:t.email})]}),n.jsxs("div",{className:`agent-status ${t.isOnline?"online":"offline"}`,children:[n.jsx("span",{className:"status-dot"}),t.isOnline?"Online":"Offline"]})]},t._id))}):n.jsx("div",{className:"empty-state",children:c.length===0?"No agents available":"No matching agents"})})]})]}),h.length>0&&n.jsxs("div",{className:"selected-agents",children:[n.jsxs("h4",{children:["Selected Agents (",h.length,")"]}),n.jsx("div",{className:"agents-grid",children:h.map(t=>{const d=c.find(N=>N._id===t),f=!!k[t];return n.jsxs("div",{className:"agent-card",children:[n.jsxs("div",{className:"agent-card-header",children:[n.jsx("span",{className:"agent-card-name",children:(d==null?void 0:d.userName)||t}),n.jsx("span",{className:`sharing-badge ${f?"active":"pending"}`,children:f?"ðŸ”´ Sharing":"â³ Waiting"})]}),n.jsx("div",{className:"agent-card-email",children:d==null?void 0:d.email})]},t)})})]})]})},K=()=>{var $,D,P;const{auth:r}=W(),s=B(),h=($=r==null?void 0:r.user)==null?void 0:$.role,[k,m]=g.useState(""),[c,y]=g.useState(()=>{try{const e=sessionStorage.getItem("admin_agent_list");return e?JSON.parse(e):[]}catch(e){return console.warn("Failed to parse stored admin_agent_list",e),[]}}),[_,L]=g.useState([]),{remoteStreams:w,addRemoteStream:R,removeRemoteStream:A,pcMapRef:I,setPC:q,getPC:T,closePC:O,clearAll:j}=J(),S=I,u=g.useRef(new Set),t=g.useRef(null);g.useEffect(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:"smooth"})},[w]),g.useEffect(()=>{const e=()=>{var l;console.log("ðŸ”„ Admin page unloading, cleaning up and notifying agents...");const i=Object.values(w).map(a=>a.fromAgentId);try{j()}catch(a){console.warn("Error during clearAll:",a)}s&&s.connected&&i.length>0&&(s.emit("admin-disconnecting",{adminSocketId:s.id,adminId:((l=r==null?void 0:r.user)==null?void 0:l._id)||null,agentIds:i,reason:"page-refresh-or-close"}),console.log("âœ… Notified agents of disconnect:",i))};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[s,w,(D=r==null?void 0:r.user)==null?void 0:D._id,j]),g.useEffect(()=>{if(s)return s.on("offer",async({fromSocketId:e,fromUserId:i,fromAgentId:l,sdp:a})=>{var E;const o=l||i||e;console.log("admin got offer from peer",o,"(socket:",e,") agentId",l,"userId",i);try{if(S.current[o]){console.log("ðŸ”„ Cleaning up stale PC for agent",l||o);const p=S.current[o];p.close(),p.getSenders().forEach(C=>{C.track&&C.track.stop()}),delete S.current[o]}const v=JSON.parse('[{"urls":["stun:stun.l.google.com:19302"]},{"urls":"turn:yourturnserver:3478","username":"turnuser","credential":"turnpass"}]'),x=H({iceServers:v,onTrack:p=>{const[C]=p.streams;R(o,{stream:C,fromAgentId:l,fromUserId:i})},onIceCandidate:p=>{s.emit("ice-candidate",{toSocketId:l||i||e,candidate:p})}});x.onconnectionstatechange=()=>{var C;const p=x.connectionState;console.log("ðŸ”Œ Admin PC connection state changed to:",p,"for agent",l),(p==="closed"||p==="failed"||p==="disconnected")&&(console.log("ðŸ“¤ Removing admin PC for agent",l,"due to state:",p),S.current[o]&&delete S.current[o],A(o),s&&(s.emit("admin-pc-closed",{adminSocketId:s.id,adminId:((C=r==null?void 0:r.user)==null?void 0:C._id)||null,agentId:l||i||o,connectionState:p}),console.log("ðŸ“¤ Notified backend that admin PC closed for agent",l||i||o)))},q(o,x),await x.setRemoteDescription(new RTCSessionDescription(a));const b=await x.createAnswer();await x.setLocalDescription(b),s.emit("answer",{toSocketId:l||i||e,adminId:((E=r==null?void 0:r.user)==null?void 0:E._id)||null,sdp:x.localDescription})}catch(v){console.error("admin error handling offer:",v)}}),s.on("ice-candidate",async({fromSocketId:e,fromUserId:i,candidate:l})=>{try{const a=i||e,o=I.current[a]||T(a);if(!o)return console.warn("No pc found for ICE candidate from",a);await o.addIceCandidate(new RTCIceCandidate(l))}catch(a){console.warn("Error adding ICE candidate (admin):",a)}}),s.on("request-denied",({reason:e})=>{alert("View request denied: "+e)}),s.on("disconnect",()=>{console.log("âš ï¸ Socket disconnected, cleaning up all PCs");try{j()}catch(e){console.warn("Error during clearAll on disconnect:",e)}}),()=>{s.off("offer"),s.off("ice-candidate"),s.off("request-denied"),s.off("disconnect")}},[s,R,q,T,A,j,(P=r==null?void 0:r.user)==null?void 0:P._id,I]),g.useEffect(()=>{try{sessionStorage.setItem("admin_agent_list",JSON.stringify(c||[]))}catch(e){console.warn("Failed to persist admin_agent_list",e)}},[c]),g.useEffect(()=>{s&&c&&c.length>0&&c.forEach(e=>{u.current.has(e)||(u.current.add(e),console.log("Recovering view for stored agentId:",e),s.emit("request-view",{agentId:e,reason:"admin-recover-session"}),setTimeout(()=>u.current.delete(e),2e3))})},[s,c]);const d=()=>{const e=k.trim();if(e){if(c.includes(e))return m("");y(i=>[...i,e]),s&&h==="admin"&&(u.current.has(e)||(console.log("auto-requesting view for agentId",e),u.current.add(e),s.emit("request-view",{agentId:e,reason:"admin-auto-request"}),setTimeout(()=>u.current.delete(e),2e3))),m("")}};g.useEffect(()=>{if(!s)return;const e=({agents:i})=>{L(i||[])};return s.on("agents-list-updated",e),s.on("agents-list",e),s.emit("get-agents-list"),()=>{s.off("agents-list-updated",e),s.off("agents-list",e)}},[s]),g.useEffect(()=>{if(!s)return;console.log("Setting up listener for connected-agents-list");const e=({agents:i,reason:l})=>{console.log(`âœ… [AdminReconnect] Received connected agents list (${(i==null?void 0:i.length)||0} agents) - reason: ${l}`),i&&Array.isArray(i)&&i.length>0&&i.forEach(a=>{const o=a.agentId||a.userId;o&&!c.includes(o)&&(console.log(`[AdminReconnect] Auto-adding agent ${o} for view`),y(E=>{const v=[...E,o];return console.log(`[AdminReconnect] Updated agentList: ${v.length} agents`),v}),s&&h==="admin"&&!u.current.has(o)&&(console.log(`[AdminReconnect] Auto-requesting view for agent ${o}`),u.current.add(o),s.emit("request-view",{agentId:o,reason:"admin-reconnect-auto"}),setTimeout(()=>{u.current.delete(o),console.log(`[AdminReconnect] Cleared pending for agent ${o}`)},2e3)))})};return s.on("connected-agents-list",e),console.log("Requesting fresh connected-agents-list from backend"),s.emit("get-connected-agents-list"),()=>{s.off("connected-agents-list",e)}},[s,h,c]);const f=()=>{if(h!=="admin")return alert("Only superadmin can request agent cameras.");if(!c.length)return alert("Add at least one agentId to view.");c.forEach(e=>{u.current.has(e)||(console.log("requesting view for agentId",e),u.current.add(e),s.emit("request-view",{agentId:e,reason:"superadmin-request"}),setTimeout(()=>u.current.delete(e),2e3))})},N=e=>{var i,l;if(console.log("stopViewing peerKey is",e),e){console.log("if condition"),O(e);const a=w?w[e]:null;if(a&&(a.fromAgentId||a.fromUserId)&&s){const o=a.fromAgentId||a.fromUserId||e;s.emit("admin-stopped-viewing",{adminSocketId:s.id,adminId:((i=r==null?void 0:r.user)==null?void 0:i._id)||null,agentId:o}),s.emit("admin-pc-closed",{adminSocketId:s.id,adminId:((l=r==null?void 0:r.user)==null?void 0:l._id)||null,agentId:o,connectionState:"closed"}),console.log("ðŸ“¤ Notified agent",o,"that admin stopped viewing and cleared dedup")}A(e)}else{console.log("else condition"),Object.entries(w||{}).forEach(([a,{fromAgentId:o,fromUserId:E}])=>{var v,x;if(O(a),s){const b=o||E||a;s.emit("admin-stopped-viewing",{adminSocketId:s.id,adminId:((v=r==null?void 0:r.user)==null?void 0:v._id)||null,agentId:b}),s.emit("admin-pc-closed",{adminSocketId:s.id,adminId:((x=r==null?void 0:r.user)==null?void 0:x._id)||null,agentId:b,connectionState:"closed"}),console.log("ðŸ“¤ Notified agent",b,"that admin stopped viewing and cleared dedup")}});try{j()}catch(a){console.warn("Error clearing all during stopViewing all:",a)}}};return n.jsx(z,{children:n.jsxs("main",{className:"crm_all_body d-flex",children:[n.jsx(F,{}),n.jsxs("section",{className:"",ref:t,style:{width:"90%",margin:"auto",overflowY:"auto",scrollBehavior:"smooth",height:"90vh"},children:[n.jsx("div",{className:"header_crm flex_props justify-content-between",children:n.jsx("p",{className:"crm_title",children:"Admin Dashboard"})}),n.jsxs("div",{style:{padding:20},children:[n.jsx(U,{onAgentSelected:e=>{c.includes(e)||y(i=>[...i,e])},onScreenShareStarted:e=>{console.log(`Screen share initiated for agent: ${e}`)},selectedAgents:c,remoteStreams:w}),n.jsxs("div",{style:{marginBottom:12,marginTop:20},children:[n.jsx("h3",{children:"Manual Agent Addition (Optional)"}),n.jsx("input",{value:k,onChange:e=>m(e.target.value),placeholder:"enter agentId and press Add"}),n.jsx("button",{onClick:d,children:"Add"}),n.jsx("button",{onClick:f,children:"Request View (superadmin)"}),n.jsx("button",{onClick:()=>N(),children:"Stop All"})]}),n.jsxs("div",{style:{marginTop:12,padding:12,border:"1px solid #eee"},children:[n.jsxs("h4",{children:["All Agents (live)",n.jsx("span",{className:"text-success",children:"*"})]}),n.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:_&&_.length?_.map(e=>n.jsxs("div",{style:{border:"1px solid #ddd",padding:8,minWidth:200},children:[n.jsx("div",{style:{fontSize:13,fontWeight:600},children:e.userName||e.email||e._id}),n.jsx("div",{style:{fontSize:12,color:e.isOnline?"green":"gray"},children:e.isOnline?"Online":"Offline"}),n.jsx("div",{style:{marginTop:6,display:"flex",gap:6},children:n.jsx("button",{onClick:()=>{console.clear(),console.log("=== Request View Debug Log ==="),console.log("Initial agentList:",c),console.log("Clicked agent ID:",e._id);const i=c.includes(e._id);console.log("Already in agentList?",i),i?console.log("Skipping: Agent already in list"):(console.log("Adding agent to agentList..."),y(a=>{console.log("Previous list:",a);const o=[...a,e._id];return console.log("New agentList:",o),o})),console.log("Socket available?",!!s),console.log("pendingRequestsRef before:",Array.from(u.current));const l=u.current.has(e._id);console.log("Already pending?",l),s&&!l?(console.log("Adding to pendingRequestsRef & emitting socket event..."),u.current.add(e._id),console.log("Emitting: request-view",{agentId:e._id,reason:"admin-panel-request"}),s.emit("request-view",{agentId:e._id,reason:"admin-panel-request"}),setTimeout(()=>{console.log("Timeout ended. Removing from pendingRequestsRef:",e._id),u.current.delete(e._id),console.log("pendingRequestsRef after deletion:",Array.from(u.current))},2e3)):console.log("Skipping socket emit (reason: no socket or already pending)"),console.log("=== END DEBUG ===")},children:"Request View"})})]},e._id)):n.jsx("div",{style:{color:"#666"},children:"No agents found"})})]}),n.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:c.map(e=>n.jsx("div",{style:{border:"1px solid #ddd",padding:6},children:n.jsxs("div",{style:{fontSize:12},children:["AgentId: ",e]})},e))}),n.jsx("div",{style:{marginTop:20,display:"flex",gap:12,flexWrap:"wrap"},children:Object.entries(w).map(([e,{stream:i,fromAgentId:l,fromUserId:a}])=>n.jsxs("div",{style:{minWidth:240},children:[n.jsx(M,{stream:i,muted:!1,label:`Agent ${l||a||e}`}),n.jsx("div",{style:{display:"flex",gap:8},children:n.jsx("button",{onClick:()=>N(e),children:"Stop"})})]},e))})]})]})]})})};export{K as default};

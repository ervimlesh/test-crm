import{v as k,p as G,r as d,j as e,u as D,a as C,w as R,V as $}from"./index-DDoEHnfR.js";import{createPeerConnection as L}from"./Webrtc-BBRU1ZdI.js";import{L as P}from"./Layout-Co7qzEc2.js";import{S as B}from"./SideBar-DCoEgSRU.js";import{V as F}from"./VideoTile-BdOxT984.js";const q=({onShareStarted:i,onShareStopped:a,showDuration:j=!0,showActiveSharers:w=!0})=>{const{isSharing:g,shareStartTime:N,activeSharers:_,startSharing:E,stopSharing:p}=k();G();const[A,h]=d.useState(0),[t,x]=d.useState(!1),[v,m]=d.useState(null),[I,y]=d.useState(null),[l,u]=d.useState(null),[s,c]=d.useState(!1);d.useEffect(()=>{var n;try{const r=localStorage.getItem("auth"),f=r?JSON.parse(r):null;y(((n=f==null?void 0:f.user)==null?void 0:n.role)||null)}catch(r){console.error("Error parsing auth:",r)}},[]),d.useEffect(()=>{if(!g){h(0);return}const n=setInterval(()=>{N&&h(Math.floor((Date.now()-N)/1e3))},1e3);return()=>clearInterval(n)},[g,N]);const o=n=>{const r=Math.floor(n/3600),f=Math.floor(n%3600/60),M=n%60;return r>0?`${r}h ${f}m ${M}s`:f>0?`${f}m ${M}s`:`${M}s`},T=async(n="screen")=>{x(!0),m(null);try{let r;switch(n){case"screen":r=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!0});break;case"window":r=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!1});break;case"camera":r=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:!0});break;default:r=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!0})}await E(r)?(u(n),c(!1),console.log(`[ScreenShareButton] ${n} share started successfully`),i==null||i(n)):m("Failed to start screen sharing")}catch(r){console.error("[ScreenShareButton] Error starting share:",r),r.name==="NotAllowedError"?m("Screen sharing permission denied"):r.name==="NotFoundError"?m("No screens or windows available to share"):r.name==="SecurityError"?m("Screen sharing is not allowed by your browser"):m("Failed to start screen sharing")}finally{x(!1)}},S=async()=>{x(!0),m(null);try{await p()?(u(null),c(!1),console.log("[ScreenShareButton] Share stopped successfully"),a==null||a()):m("Failed to stop screen sharing")}catch(n){console.error("[ScreenShareButton] Error stopping share:",n),m("Failed to stop screen sharing")}finally{x(!1)}};return e.jsxs("div",{className:"screen-share-button-container",children:[!g&&e.jsxs("div",{className:"share-mode-selector",children:[e.jsxs("button",{className:`screen-share-button ${t?"loading":""}`,onClick:()=>c(!s),disabled:t,title:"Select sharing mode",children:[e.jsx("span",{className:"share-icon",children:t?"â³":"ðŸŽ¥"}),e.jsx("span",{className:"share-text",children:t?"Loading...":"Share Screen"}),e.jsx("span",{className:`chevron ${s?"open":""}`,children:"â–¼"})]}),s&&e.jsxs("div",{className:"share-mode-menu",children:[e.jsxs("button",{className:"share-mode-option",onClick:()=>T("screen"),disabled:t,children:[e.jsx("span",{className:"mode-icon",children:"ðŸ“º"}),e.jsxs("div",{className:"mode-info",children:[e.jsx("div",{className:"mode-title",children:"Share Entire Screen"}),e.jsx("div",{className:"mode-description",children:"Share your full screen"})]})]}),e.jsxs("button",{className:"share-mode-option",onClick:()=>T("window"),disabled:t,children:[e.jsx("span",{className:"mode-icon",children:"ðŸ“„"}),e.jsxs("div",{className:"mode-info",children:[e.jsx("div",{className:"mode-title",children:"Share a Window"}),e.jsx("div",{className:"mode-description",children:"Share specific application window"})]})]}),e.jsxs("button",{className:"share-mode-option",onClick:()=>T("camera"),disabled:t,children:[e.jsx("span",{className:"mode-icon",children:"ðŸ“·"}),e.jsxs("div",{className:"mode-info",children:[e.jsx("div",{className:"mode-title",children:"Share Camera"}),e.jsx("div",{className:"mode-description",children:"Share your webcam"})]})]})]})]}),g&&e.jsxs("button",{className:`screen-share-button active ${t?"loading":""}`,onClick:S,disabled:t,title:"Click to stop sharing",children:[e.jsx("span",{className:"share-icon",children:"ðŸ”´"}),e.jsx("span",{className:"share-text",children:t?"Loading...":"Stop Sharing"}),j&&e.jsx("span",{className:"share-duration",children:o(A)})]}),v&&e.jsx("div",{className:"share-error-message",children:v}),w&&_&&_.length>0&&e.jsxs("div",{className:"active-sharers-list",children:[e.jsxs("div",{className:"sharers-label",children:["ðŸ”´ Active Sharers (",_.length,")"]}),e.jsx("ul",{className:"sharers-items",children:_.map((n,r)=>e.jsxs("li",{className:"sharer-item",children:[e.jsx("span",{className:"sharer-name",children:n.userName||n.userId}),e.jsx("span",{className:"sharer-time",children:n.startTime?o(Math.floor((Date.now()-n.startTime)/1e3)):""})]},`${n.userId}-${r}`))})]}),g&&e.jsx("div",{className:"share-status-message",children:"âœ… Screen sharing is active. Admins can view your screen."}),!g&&_.length>0&&e.jsx("div",{className:"share-waiting-message",children:"â³ Other users are currently sharing. You can also start sharing."})]})};window.__AGENT_STREAM__||(window.__AGENT_STREAM__=null);window.__GETTING_STREAM__||(window.__GETTING_STREAM__=!1);const b=async()=>{if(window.__AGENT_STREAM__)return window.__AGENT_STREAM__;if(window.__GETTING_STREAM__)return new Promise(i=>{const a=setInterval(()=>{window.__AGENT_STREAM__&&(clearInterval(a),i(window.__AGENT_STREAM__))},200)});try{window.__GETTING_STREAM__=!0;const i=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});return window.__AGENT_STREAM__=i,window.__GETTING_STREAM__=!1,localStorage.setItem("crm_screen_permission","granted"),i.getTracks().forEach(a=>{a.onended=()=>{window.__AGENT_STREAM__=null,localStorage.removeItem("crm_screen_permission")}}),i}catch{return window.__GETTING_STREAM__=!1,null}},J=()=>{var m,I,y;const{auth:i}=D(),a=G(),j=C(),w=((m=i==null?void 0:i.user)==null?void 0:m._id)||"",g=(I=i==null?void 0:i.user)==null?void 0:I.role,{remoteStreams:N,addRemoteStream:_,removeRemoteStream:E}=k(),p=`agent_${w}`,A=N?(y=N[p])==null?void 0:y.stream:null,h=d.useRef(null),t=d.useRef({}),[x,v]=d.useState(!1);return d.useEffect(()=>{R&&R.isCurrentlySharing()&&v(!0)},[]),d.useEffect(()=>{const l=!window.crm_agent_home_loaded;window.crm_agent_home_loaded=!0;const u=localStorage.getItem("crm_screen_permission")==="granted";l&&u&&(console.log("ðŸ“Œ Page refreshed â€” restoring stream..."),b().then(s=>{if(s){window.agentScreenStream=s;try{h.current=s,_(p,{stream:s,fromAgentId:w}),v(!0),s.getTracks().forEach(c=>{c.addEventListener("ended",()=>{h.current&&(h.current.getTracks().forEach(o=>o.stop()),h.current=null),E(p),v(!1),localStorage.removeItem("crm_screen_permission")})})}catch(c){console.warn("Error attaching stream after refresh:",c)}}}))},[]),d.useEffect(()=>{if(console.log("before socket "),!!a)return console.log("after socket"),a.emit("join",{userId:w,role:g,agentId:g==="agent"?w:void 0}),a.on("viewer-request",async({adminSocketId:l,adminId:u})=>{console.log("viewer-request from admin",l,"adminId:",u);try{const s=u||l,c=t.current[s];if(c&&c.connectionState!=="closed"&&c.connectionState!=="failed"){console.log(`âš ï¸ PC already exists for admin ${s}, skipping`);return}c&&(c.close(),c.getSenders().forEach(r=>{var f;return(f=r.track)==null?void 0:f.stop()}),delete t.current[s]);let o=window.agentScreenStream;if(o||(o=await b(),o&&(window.agentScreenStream=o)),!o)return $.error("Unable to restore screen. Please re-login."),j("/login");h.current=o,_(p,{stream:o,fromAgentId:w}),v(!0);const T=JSON.parse('[{"urls":["stun:stun.l.google.com:19302"]},{"urls":"turn:yourturnserver:3478","username":"turnuser","credential":"turnpass"}]'),S=L({iceServers:T,onIceCandidate:r=>{a.emit("ice-candidate",{toSocketId:s,candidate:r})}});S.onconnectionstatechange=()=>{const r=S.connectionState;console.log(`ðŸ”Œ PC state changed: ${r} for admin ${s}`),["closed","failed","disconnected"].includes(r)&&(t.current[s]&&(t.current[s].close(),delete t.current[s]),a.emit("agent-pc-closed",{agentId:w,adminSocketId:s,connectionState:r}))},o.getTracks().forEach(r=>S.addTrack(r,o));const n=await S.createOffer();await S.setLocalDescription(n),t.current[s]=S,a.emit("offer",{adminId:s,toSocketId:s,sdp:S.localDescription})}catch(s){console.error("Error processing viewer request:",s)}}),a.on("answer",async({fromUserId:l,fromSocketId:u,sdp:s})=>{const c=l||u,o=t.current[c];o&&await o.setRemoteDescription(new RTCSessionDescription(s))}),a.on("ice-candidate",async({fromUserId:l,fromSocketId:u,candidate:s})=>{const c=l||u,o=t.current[c];o&&await o.addIceCandidate(new RTCIceCandidate(s))}),a.on("admin-disconnecting",({adminSocketId:l,adminId:u})=>{const s=u||l;t.current[s]&&(t.current[s].close(),delete t.current[s])}),a.on("disconnect",()=>{Object.values(t.current).forEach(l=>l.close()),t.current={},h.current&&(h.current.getTracks().forEach(l=>l.stop()),h.current=null),E(p),v(!1)}),()=>{a.off("viewer-request"),a.off("answer"),a.off("ice-candidate"),a.off("request-denied"),a.off("admin-disconnecting"),a.off("admin-reconnected")}},[a,w,g,p,_,E,j]),e.jsx(P,{children:e.jsxs("main",{className:"crm_all_body d-flex",children:[e.jsx(B,{}),e.jsxs("section",{style:{width:"90%",margin:"auto"},children:[e.jsx("p",{className:"crm_title",children:"Agent Dashboard"}),e.jsx(q,{showDuration:!0,showActiveSharers:!0}),e.jsx(F,{stream:A,muted:!0,label:"Your View"})]})]})})};export{J as default};
